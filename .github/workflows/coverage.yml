name: Coverage Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: identity_db_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

      etcd:
        image: quay.io/coreos/etcd:v3.5.9
        env:
          ETCD_NAME: node1
          ETCD_INITIAL_ADVERTISE_PEER_URLS: http://0.0.0.0:2380
          ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_ADVERTISE_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_INITIAL_CLUSTER: node1=http://0.0.0.0:2380
          ETCD_INITIAL_CLUSTER_TOKEN: etcd-cluster
          ETCD_INITIAL_CLUSTER_STATE: new
        ports:
          - 2379:2379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate Swagger docs
        working-directory: gateway
        run: swag init --parseDependencyLevel 1 --useStructName true

      - name: Run RPC tests with coverage
        working-directory: rpc/identity_srv
        env:
          DB_DSN: host=localhost port=5432 user=test_user password=test_password dbname=identity_db_test sslmode=disable
          REDIS_ADDR: localhost:6379
          ETCD_ADDR: localhost:2379
        run: |
          go test -v -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate RPC coverage report
        working-directory: rpc/identity_srv
        run: |
          go tool cover -html=coverage.out -o coverage.html
          go tool cover -func=coverage.out | tee coverage.txt

      - name: Run Gateway tests with coverage
        working-directory: gateway
        run: |
          go test -v -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate Gateway coverage report
        working-directory: gateway
        run: |
          go tool cover -html=coverage.out -o coverage.html
          go tool cover -func=coverage.out | tee coverage.txt

      - name: Merge coverage profiles
        run: |
          # åˆå¹¶è¦†ç›–ç‡æ–‡ä»¶
          go install github.com/wadey/gocovmerge@latest
          gocovmerge rpc/identity_srv/coverage.out gateway/coverage.out > coverage.out

      - name: Generate HTML report
        run: |
          go tool cover -html=coverage.out -o coverage.html
          go tool cover -func=coverage.out | tee coverage-summary.txt

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            
            // æ ¹æ®è¦†ç›–ç‡é€‰æ‹©é¢œè‰²
            let color = 'red';
            if (coverage >= 80) color = 'brightgreen';
            else if (coverage >= 60) color = 'yellow';
            
            const comment = `## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

            æ€»ä½“è¦†ç›–ç‡: **${coverage}%**

            <details>
            <summary>æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</summary>

            - RPC æœåŠ¡: [æŸ¥çœ‹æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Gateway æœåŠ¡: [æŸ¥çœ‹æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            </details>

            ![coverage](https://img.shields.io/badge/coverage-${coverage}-${color})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.run_number }}
          path: |
            coverage.out
            coverage.html
            coverage-summary.txt
            rpc/identity_srv/coverage.out
            rpc/identity_srv/coverage.html
            gateway/coverage.out
            gateway/coverage.html
          retention-days: 30

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "æ€»ä½“è¦†ç›–ç‡: $COVERAGE%"
          THRESHOLD=30
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ è¦†ç›–ç‡ ${COVERAGE}% ä½äºé˜ˆå€¼ ${THRESHOLD}%"
            exit 1
          else
            echo "âœ… è¦†ç›–ç‡ ${COVERAGE}% è¾¾åˆ°é˜ˆå€¼ ${THRESHOLD}%"
          fi
