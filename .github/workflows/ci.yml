name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # 快速检查 - 每次提交都运行
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Check code format
        run: |
          go install github.com/incu6us/goimports-reviser@latest
          goimports-reviser -check -format ./...

      - name: Run go vet
        run: |
          cd rpc/identity_srv && go vet ./...
          cd ../../gateway && go vet ./...

      - name: Check for TODO/FIXME/HACK
        run: |
          if grep -rn "TODO\|FIXME\|HACK" --include="*.go" .; then
            echo "⚠️ 发现 TODO/FIXME/HACK 标记"
            grep -rn "TODO\|FIXME\|HACK" --include="*.go" .
          fi

  # 完整测试 - 在 PR 和 main 分支运行
  full-test:
    name: Full Test
    runs-on: ubuntu-latest
    needs: quick-check
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: identity_db_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

      etcd:
        image: quay.io/coreos/etcd:v3.5.9
        env:
          ETCD_NAME: node1
          ETCD_INITIAL_ADVERTISE_PEER_URLS: http://0.0.0.0:2380
          ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_ADVERTISE_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_INITIAL_CLUSTER: node1=http://0.0.0.0:2380
          ETCD_INITIAL_CLUSTER_TOKEN: etcd-cluster
          ETCD_INITIAL_CLUSTER_STATE: new
        ports:
          - 2379:2379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: |
          cd rpc/identity_srv && go mod download
          cd ../../gateway && go mod download

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate Swagger docs
        working-directory: gateway
        run: swag init --parseDependencyLevel 1 --useStructName true

      - name: Run RPC tests
        working-directory: rpc/identity_srv
        env:
          DB_DSN: host=localhost port=5432 user=test_user password=test_password dbname=identity_db_test sslmode=disable
          REDIS_ADDR: localhost:6379
          ETCD_ADDR: localhost:2379
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Run Gateway tests
        working-directory: gateway
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Generate coverage
        run: |
          go install github.com/wadey/gocovmerge@latest
          gocovmerge rpc/identity_srv/coverage.out gateway/coverage.out > coverage.out
          go tool cover -func=coverage.out

      - name: Generate coverage summary
        run: |
          go tool cover -func=coverage.out | tee coverage-summary.txt
