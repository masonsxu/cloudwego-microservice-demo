name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "docker/**"
      - "LICENSE"
      - ".github/workflows/pr-review.yml"
      - ".github/workflows/issue-killer.yml"
      - ".github/workflows/issue-triage.yaml"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "docker/**"
      - "LICENSE"
      - ".github/workflows/pr-review.yml"
      - ".github/workflows/issue-killer.yml"
      - ".github/workflows/issue-triage.yaml"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Lint（无需服务容器）
  # ──────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: false

      - name: Generate Swagger docs
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          cd gateway && swag init --parseDependencyLevel 1 --useStructName true

      - name: Lint RPC Service
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4
          working-directory: rpc/identity_srv
          args: --timeout=5m

      - name: Lint Gateway Service
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4
          working-directory: gateway
          args: --timeout=5m

      - name: Check format (RPC)
        working-directory: rpc/identity_srv
        run: |
          OUTPUT=$(golangci-lint fmt --diff 2>&1) || true
          if [ -n "$OUTPUT" ]; then
            echo "::error::RPC 代码格式不一致，请运行 golangci-lint fmt"
            echo "$OUTPUT"
            exit 1
          fi

      - name: Check format (Gateway)
        working-directory: gateway
        run: |
          OUTPUT=$(golangci-lint fmt --diff 2>&1) || true
          if [ -n "$OUTPUT" ]; then
            echo "::error::Gateway 代码格式不一致，请运行 golangci-lint fmt"
            echo "$OUTPUT"
            exit 1
          fi

  # ──────────────────────────────────────────────
  # Job 2: Test RPC - Unit Tests（无服务容器，快速）
  # ──────────────────────────────────────────────
  test-rpc-unit:
    name: Test RPC (Unit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: rpc/identity_srv/go.sum

      - name: Download dependencies
        working-directory: rpc/identity_srv
        run: go mod download

      - name: Run unit tests (with retry)
        working-directory: rpc/identity_srv
        shell: bash
        run: |
          MAX_RETRIES=2
          RETRY_COUNT=0

          while [ $RETRY_COUNT -le $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $((MAX_RETRIES + 1))"

            # 运行单元测试（排除集成测试，使用 -short 标志）
            if go test -v -race -short \
              -coverprofile=coverage-unit.out \
              -covermode=atomic \
              ./biz/... ./pkg/...; then
              echo "Tests passed"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -le $MAX_RETRIES ]; then
              echo "Tests failed, retrying..."
              sleep 5
            fi
          done

          echo "Tests failed after $((MAX_RETRIES + 1)) attempts"
          exit 1

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-rpc-unit
          path: rpc/identity_srv/coverage-unit.out
          retention-days: 7

  # ──────────────────────────────────────────────
  # Job 3: Test RPC - Integration Tests（需要服务容器）
  # ──────────────────────────────────────────────
  test-rpc-integration:
    name: Test RPC (Integration)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: identity_db_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      etcd:
        image: quay.io/coreos/etcd:v3.5.16
        env:
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_ADVERTISE_CLIENT_URLS: http://0.0.0.0:2379
        ports:
          - 2379:2379
        options: >-
          --health-cmd "ETCDCTL_API=3 etcdctl get hello"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: rpc/identity_srv/go.sum

      - name: Wait for services
        run: |
          echo "Waiting for services to be ready..."
          sleep 10

      - name: Download dependencies
        working-directory: rpc/identity_srv
        run: go mod download

      - name: Run integration tests (with retry)
        working-directory: rpc/identity_srv
        env:
          DB_DSN: host=localhost port=5432 user=test_user password=test_password dbname=identity_db_test sslmode=disable
          REDIS_ADDR: localhost:6379
          ETCD_ADDR: localhost:2379
        shell: bash
        run: |
          MAX_RETRIES=2
          RETRY_COUNT=0

          while [ $RETRY_COUNT -le $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $((MAX_RETRIES + 1))"

            # 运行集成测试（不使用 -short，完整运行）
            if go test -v -race \
              -coverprofile=coverage-integration.out \
              -covermode=atomic \
              ./biz/logic/...; then
              echo "Tests passed"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -le $MAX_RETRIES ]; then
              echo "Tests failed, retrying..."
              sleep 5
            fi
          done

          echo "Tests failed after $((MAX_RETRIES + 1)) attempts"
          exit 1

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-rpc-integration
          path: rpc/identity_srv/coverage-integration.out
          retention-days: 7

  # ──────────────────────────────────────────────
  # Job 4: Test Gateway（无需服务容器）
  # ──────────────────────────────────────────────
  test-gateway:
    name: Test Gateway Service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: gateway/go.sum

      - name: Download dependencies
        working-directory: gateway
        run: go mod download

      - name: Generate Swagger docs
        working-directory: gateway
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          swag init --parseDependencyLevel 1 --useStructName true

      - name: Run tests (with retry)
        working-directory: gateway
        shell: bash
        run: |
          MAX_RETRIES=2
          RETRY_COUNT=0

          while [ $RETRY_COUNT -le $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $((MAX_RETRIES + 1))"

            if go test -v -race \
              -coverprofile=coverage.out \
              -covermode=atomic \
              ./...; then
              echo "Tests passed"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -le $MAX_RETRIES ]; then
              echo "Tests failed, retrying..."
              sleep 5
            fi
          done

          echo "Tests failed after $((MAX_RETRIES + 1)) attempts"
          exit 1

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-gateway
          path: gateway/coverage.out

  # ──────────────────────────────────────────────
  # Job 5: Build（依赖 lint）
  # ──────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Generate Swagger docs
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          cd gateway && swag init --parseDependencyLevel 1 --useStructName true

      - name: Build RPC Service
        working-directory: rpc/identity_srv
        run: go build -o /dev/null .

      - name: Build Gateway Service
        working-directory: gateway
        run: go build -o /dev/null .

  # ──────────────────────────────────────────────
  # Job 6: Coverage（依赖所有测试，仅 PR 时运行）
  # ──────────────────────────────────────────────
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-rpc-unit, test-rpc-integration, test-gateway]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage

      - name: Merge RPC coverage
        run: |
          mkdir -p coverage/rpc
          gocovmerge coverage/coverage-rpc-unit/coverage-unit.out \
            coverage/coverage-rpc-integration/coverage-integration.out \
            > coverage/rpc/coverage.out || true

      - name: Calculate coverage
        id: cov
        run: |
          go install github.com/wadey/gocovmerge@latest

          # RPC 覆盖率
          RPC=$(go tool cover -func=coverage/coverage-rpc-unit/coverage-unit.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "rpc=$RPC" >> $GITHUB_OUTPUT

          # Gateway 覆盖率
          GW=$(go tool cover -func=coverage/coverage-gateway/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "gateway=$GW" >> $GITHUB_OUTPUT

          # 总体覆盖率
          TOTAL=$(echo "scale=1; ($RPC + $GW) / 2" | bc)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.cov.outputs.total }}
          THRESHOLD=70
          echo "Total coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

      - name: Comment coverage on PR
        uses: actions/github-script@v7
        with:
          script: |
            const rpc = '${{ steps.cov.outputs.rpc }}';
            const gw = '${{ steps.cov.outputs.gateway }}';
            const total = '${{ steps.cov.outputs.total }}';
            const threshold = 70;

            function statusIcon(pct) {
              const n = parseFloat(pct);
              if (n >= 80) return '\u{1F7E2}';
              if (n >= 70) return '\u{1F7E1}';
              if (n >= 50) return '\u{1F7E0}';
              return '\u{1F534}';
            }

            const passed = parseFloat(total) >= threshold;
            const result = passed ? '\u2705 \u8FBE\u6807' : '\u274C \u672A\u8FBE\u6807';

            const body = [
              '## \u{1F4CA} \u6D4B\u8BD5\u8986\u76D6\u7387\u62A5\u544A',
              '',
              '| \u6A21\u5757 | \u8986\u76D6\u7387 | \u72B6\u6001 |',
              '|------|--------|------|',
              `| RPC Service (Unit) | ${rpc}% | ${statusIcon(rpc)} |`,
              `| RPC Service (Integration) | Integration | \u{1F504} |`,
              `| Gateway Service | ${gw}% | ${statusIcon(gw)} |`,
              `| **\u603B\u4F53** | **${total}%** | ${statusIcon(total)} |`,
              '',
              `> \u9608\u503C: ${threshold}% | ${result}`,
              '',
              '### \u{1F4A1} \u4F18\u5316\u5EFA\u8BAE',
              '- \u5355\u5143\u6D4B\u8BD5\u548C\u96C6\u6210\u6D4B\u8BD5\u5206\u79BB\u8FD0\u884C',
              '- \u6D4B\u8BD5\u5931\u8D25\u65F6\u81EA\u52A8\u91CD\u8BD5\uFF08\u6700\u591A 2 \u6B21\uFF09',
              '- \u8986\u76D6\u7387\u9608\u503C\u63D0\u5347\u81F3 70%',
            ].join('\n');

            // 查找已有的覆盖率评论并更新
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '\u{1F4CA} \u6D4B\u8BD5\u8986\u76D6\u7387\u62A5\u544A';
            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Upload merged coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-merged-${{ github.run_number }}
          path: coverage
          retention-days: 30
