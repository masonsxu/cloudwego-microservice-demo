name: Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test-rpc:
    name: Test RPC Service
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: identity_db_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      etcd:
        image: quay.io/coreos/etcd:v3.5.9
        env:
          ETCD_NAME: node1
          ETCD_INITIAL_ADVERTISE_PEER_URLS: http://0.0.0.0:2380
          ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_ADVERTISE_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_INITIAL_CLUSTER: node1=http://0.0.0.0:2380
          ETCD_INITIAL_CLUSTER_TOKEN: etcd-cluster
          ETCD_INITIAL_CLUSTER_STATE: new
        ports:
          - 2379:2379
        options: >-
          --health-cmd "etcdctl endpoint health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: rpc/identity_srv/go.sum

      - name: Download Go dependencies
        working-directory: rpc/identity_srv
        run: go mod download

      - name: Run tests
        working-directory: rpc/identity_srv
        env:
          DB_DSN: host=localhost port=5432 user=test_user password=test_password dbname=identity_db_test sslmode=disable
          REDIS_ADDR: localhost:6379
          ETCD_ADDR: localhost:2379
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage report
        working-directory: rpc/identity_srv
        run: go tool cover -func=coverage.out

  test-gateway:
    name: Test Gateway Service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: gateway/go.sum

      - name: Download Go dependencies
        working-directory: gateway
        run: go mod download

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate Swagger docs
        working-directory: gateway
        run: swag init --parseDependencyLevel 1 --useStructName true

      - name: Run tests
        working-directory: gateway
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage report
        working-directory: gateway
        run: go tool cover -func=coverage.out

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run golangci-lint
        run: |
          cd rpc/identity_srv && golangci-lint run --timeout=5m ./...
          cd ../../gateway && golangci-lint run --timeout=5m ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test-rpc, test-gateway, lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate Swagger docs
        working-directory: gateway
        run: swag init --parseDependencyLevel 1 --useStructName true

      - name: Build RPC service
        working-directory: rpc/identity_srv
        run: |
          go build -v -o /tmp/identity_srv ./cmd/main.go

      - name: Build Gateway service
        working-directory: gateway
        run: |
          go build -v -o /tmp/gateway ./cmd/main.go
