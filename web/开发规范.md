# 前端开发规范

## 项目结构

```
web/
├── src/
│   ├── api/                    # API 层
│   │   ├── generated/          # openapi-typescript-codegen 生成代码（勿手动修改）
│   │   ├── config.ts           # API 客户端配置（集中管理）
│   │   ├── request.ts          # 自定义 axios 实例（带拦截器）
│   │   ├── auth.ts             # 认证 API
│   │   ├── user.ts             # 用户 API
│   │   ├── organization.ts     # 组织 API
│   │   └── role.ts             # 角色 API
│   ├── stores/                 # Pinia 状态管理
│   ├── views/                  # 页面组件
│   ├── router/                 # 路由配置
│   ├── locales/                # 国际化
│   └── types/                  # TypeScript 类型定义
```

## API 客户端管理

### ⚠️ 重要：自动生成代码的 Token 配置问题

**问题根因**：`openapi-typescript-codegen` 生成的代码默认 `TOKEN: undefined`，导致认证失败。

**解决方案**：使用配置文件集中管理，避免手动修改生成的文件。

### 重新生成 API 客户端

```bash
cd web
npm run regen-api
```

此脚本会：
1. 下载最新的 Swagger 文档
2. 重新生成 API 客户端代码
3. **注意**：TOKEN 配置由 `src/api/config.ts` 在应用启动时自动设置，无需手动修改

### API 客户端配置

在 `src/api/config.ts` 中集中管理：

```typescript
import { OpenAPI } from '@/api/generated'

// 应用启动时调用
export function initApiClient() {
  OpenAPI.TOKEN = () => Promise.resolve(localStorage.getItem('token') || '')
  OpenAPI.BASE = 'http://192.168.20.66:8088'
}

// 用户登出时调用
export function clearApiClient() {
  OpenAPI.TOKEN = undefined
}
```

### 使用生成的 API

```typescript
import { roleApi } from '@/api/role'

// ✅ 使用生成的 API（自动带 token）
const response = await roleApi.getRoles({ name: 'admin' })
```

### 何时使用自定义 request.ts

仅在以下情况使用 `src/api/request.ts`：
- 需要特殊的请求/响应拦截逻辑
- 需要处理生成代码不支持的场景
- 处理文件上传/下载等特殊场景

## 样式规范

### CSS @import 顺序规则

**规则**：在 CSS/PostCSS 文件中，所有 `@import` 语句必须位于文件最顶部，在任何其他语句（`@theme`、`@layer`、规则集等）之前。

```css
/* ✅ 正确 */
@import "tailwindcss";
@import './element-theme.scss';

@theme { ... }

body { ... }
```

```css
/* ❌ 错误：@import 在 @theme 之后，PostCSS 会忽略它 */
@import "tailwindcss";

@theme { ... }

@import './element-theme.scss';   /* 此 import 会被静默忽略！ */
```

**后果**：违反此规则时，PostCSS 会报 `@import must precede all other statements` 错误，并静默忽略该 import，导致被引入的样式文件完全不生效，且不易察觉（页面不报运行时错误）。

**适用范围**：`tailwind.css` 及项目中所有 `.css` 文件。

### 样式文件职责划分

| 文件 | 职责 |
|------|------|
| `variables.css` | 自定义设计系统变量（`--bg-*`、`--c-*`、`--shadow-*` 等） |
| `element-theme.scss` | El+ CSS 变量覆盖（`:root` 块） + 组件级选择器覆盖（`.el-table` 等） |
| `tailwind.css` | Tailwind 主题配置（`@theme`）+ 全局样式 + 工具类 |

每类变量只在一处维护，避免跨文件重复声明。

### 国际化 i18n Key 使用规范

**规则**：只能将**叶子节点 key** 传给 `t()` 函数用于渲染文本；将嵌套对象 key 传给 `t()` 时，vue-i18n v9 会返回 key 路径字符串而非翻译文本。

```typescript
// zh-CN.ts
user: {
  status: {          // ← 嵌套对象，非叶子节点
    active: '活跃',  // ← 叶子节点 ✅
    locked: '锁定',  // ← 叶子节点 ✅
  }
}
```

```html
<!-- ✅ 正确：使用叶子节点 key -->
<el-table-column :label="t('common.status')" />
<span>{{ t('user.status.active') }}</span>

<!-- ❌ 错误：user.status 是对象，渲染结果为 "USER.STATUS"（经 text-transform 后） -->
<el-table-column :label="t('user.status')" />
```

**检查方式**：凡是在 `locales/` 中定义了子键的 key（如 `user.gender`、`user.status`、`role.permissionLevel`），一律不能直接作为显示文本使用。



### 组件开发

1. **使用 Composition API**
   ```vue
   <script setup lang="ts">
   import { ref, onMounted } from 'vue'
   </script>
   ```

2. **类型安全**
   - 优先使用生成的类型（`@/api/generated/models`）
   - 避免使用 `any`

3. **国际化**
   - 所有显示文本必须使用 `t()` 函数
   - 在 `src/locales/` 中添加翻译

### 状态管理

- 使用 Pinia stores
- 持久化关键状态到 localStorage
- 在 `App.vue` 中初始化

### 路由

- 在 `src/router/routes.ts` 中配置路由
- 使用懒加载：`component: () => import('@/views/...')`
- 设置正确的 meta 信息（title, icon 等）

## 常见问题

### Q: 重新生成 API 后认证失败？
A: 确保在 `App.vue` 的 `onMounted` 中调用了 `initApiClient()`

### Q: 生成的类型不符合需求？
A: 不要修改生成的文件，在 `src/types/` 中扩展类型

### Q: 如何添加新的 API 端点？
A:
1. 后端先修改 IDL 并重新生成
2. 前端运行 `npm run regen-api`
3. 在对应的 API 文件（如 `role.ts`）中封装调用方法
