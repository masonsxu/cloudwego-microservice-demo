# 菜单导航问题修复记录

## 问题描述

点击侧边栏菜单没有任何反应，无法导航到对应页面。

## 根本原因

1. **类型不匹配**：前端手写的类型定义与后端实际 API 结构不一致
2. **路径映射错误**：后端菜单的子项使用**相对路径**（如 `"organization-management"`），而不是绝对路径（如 `"/system-settings/organization-management"`）

## 修复内容

### 1. 更新 API 客户端生成

**命令**：
```bash
cd web && ./scripts/generate-api-from-swagger.sh http://192.168.20.66:8088/swagger/doc.json
```

**生成文件**：
- `web/src/api/generated/models/*` - 类型定义
- `web/src/api/generated/services/*` - API 客户端

### 2. 修复类型导入

**文件**：`web/src/stores/auth.ts`

```typescript
// 修改前
import type { MenuItem, Role, MenuPermission } from '@/types/user'

// 修改后
import type { MenuNodeDTO, RoleInfoDTO, MenuPermissionDTO } from '@/api/generated'
```

### 3. 修复路径映射

**文件**：`web/src/components/layout/AppSidebar.vue`

**后端菜单数据结构**：
```json
{
  "name": "系统设置",
  "path": "/system-settings",  // 绝对路径
  "children": [
    {
      "name": "组织管理",
      "path": "organization-management",  // 相对路径！
    }
  ]
}
```

**修复后的映射**：
```typescript
const pathMapping: Record<string, string> = {
  // 绝对路径（顶级菜单）
  '/system-settings': '/system-settings',
  // 相对路径映射（二级菜单）
  'organization-management': '/system-settings/organization',
  'role-permissions': '/system-settings/roles',
  'account-management': '/system-settings/accounts'
}

function getMenuIndex(menu: MenuNodeDTO): string {
  const originalPath = menu.path || ''

  if (originalPath.startsWith('/')) {
    // 绝对路径直接映射
    return pathMapping[originalPath] || originalPath
  }

  // 相对路径查找映射
  const mapped = pathMapping[originalPath]
  if (mapped) {
    return mapped
  }

  return originalPath
}
```

### 4. 更新 API 配置

**文件**：`web/.env.development`

```bash
VITE_API_BASE_URL=http://192.168.20.66:8088
```

### 5. 修复类型兼容性

**文件**：`web/src/api/auth.ts`

```typescript
import type { LoginResponseDTO } from '@/api/generated'

type LoginResponseData = Omit<LoginResponseDTO, 'base_resp'>
```

## 验证方法

1. 登录成功后，检查控制台输出：
   ```
   [AppSidebar] menuTree: [...]
   ```

2. 点击侧边栏菜单项（如"组织管理"）

3. 应该能成功导航到 `/system-settings/organization` 页面

## 关键发现

### 后端菜单数据结构（通过 API 测试）

```json
{
  "menu_tree": [
    {
      "name": "系统设置",
      "id": "system_settings",
      "path": "/system-settings",
      "icon": "IconSystemSettings",
      "children": [
        {
          "name": "组织管理",
          "id": "organization_management",
          "path": "organization-management",  // 相对路径
          "icon": "IconOrganizationManagement"
        },
        {
          "name": "角色权限",
          "id": "role_permissions",
          "path": "role-permissions",
          "icon": "IconRolePermissions"
        },
        {
          "name": "账号管理",
          "id": "account_management",
          "path": "account-management",
          "icon": "IconAccountManagement"
        }
      ]
    }
  ]
}
```

### TokenInfoDTO 字段差异

**实际 API**：
- `access_token`
- `expires_in`
- `token_type`

**没有 `refresh_token` 字段**

## 相关文件

| 文件 | 修改内容 |
|------|----------|
| `web/src/stores/auth.ts` | 使用生成的类型 |
| `web/src/api/auth.ts` | 使用 LoginResponseDTO |
| `web/src/components/layout/AppSidebar.vue` | 修复路径映射 |
| `web/.env.development` | 更新 API 地址 |
| `web/src/api/generated/` | 新生成（从 Swagger） |

## 后续工作

- [ ] 实现组织管理页面功能
- [ ] 实现角色权限页面功能
- [ ] 实现账号管理页面功能
- [ ] 添加菜单数据缓存优化
